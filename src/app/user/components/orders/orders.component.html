<br>
<div class="container-fluid">
  <div class="row" *ngIf="ordersListTitleIsVisible">
    <div class="col-md-10">
      <strong>All Order List</strong>
    </div>
    <div class="col-md-2">
      <button *ngIf="!helperService.isLoggedIn.value.admin" type="button" class="btn btn-dark float-right"
        (click)="addOrderPopup()" data-bs-toggle="modal" data-bs-target="#addEditOrderModal">
        Add New Order
      </button>
    </div>
  </div>
  <table class="table table-hover">
    <thead>
      <tr>
        <th scope="col">Product Name</th>
        <th scope="col">Date</th>
        <th scope="col">Number of Bids</th>
        <th scope="col">Orderer</th>
        <th scope="col" *ngIf="helperService.isLoggedIn.value.admin">Accept/Pending/Reject</th>
        <th scope="col">Order Status</th>
        <th scope="col">Action</th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let order_data of all_order_data; let i= index" (click)="viewOrderPopup(order_data.id)" data-bs-toggle="modal"
      data-bs-target="#addEditBidModal" >
        <td>{{order_data.product.name}}</td>
        <td>{{order_data.dateCreated | date}} </td>
        <td>{{order_data.bids}}</td>
        <td> {{ (order_data.orderer.length>6)? (order_data.orderer | slice:0:6)+'...':(order_data.orderer) }}</td>
        <td *ngIf="helperService.isLoggedIn.value.admin">
          <span class="sim-pointer" (click)="updateStatus(order_data,
                'ACCEPTED')">
            <i class="fa fa-check-circle" style="color: green;
                    font-size: 20px;"></i>
          </span>
          &nbsp;&nbsp;&nbsp;
          <span class="sim-pointer" (click)="updateStatus(order_data,
                'REJECTED')">
            <i class="fa fa-times-circle" style="color: red;
                    font-size: 20px;"></i>
          </span>
        </td>
        <td>{{order_data.status}}</td>
        <td>
          <span
            *ngIf="helperService.isLoggedIn.value.admin || order_data.orderer === wallet_pkh"
            class="sim-pointer cursor" (click)="editOrderPopup(order_data.id)" data-bs-toggle="modal"
            data-bs-target="#addEditOrderModal"><i class="fa fa-pencil-square-o " aria-hidden="true"></i></span>
          &nbsp;
          <span
            *ngIf="helperService.isLoggedIn.value.admin || order_data.orderer === wallet_pkh"
            class="sim-pointer cursor" (click)="deleteOrder(order_data.id)"><i class="fa
                          fa-trash" aria-hidden="true"></i>
          </span>
          <span class="cursor link" *ngIf="order_data.orderer !== wallet_pkh &&
          !helperService.isLoggedIn.value.admin" (click)="openBidDialog(order_data)" data-bs-toggle="modal"
            data-bs-target="#addEditBidModal">Bid</span>
        </td>
      </tr>
    </tbody>
  </table>
</div>

<!-- Modal for add and edit order  -->
<div class="container-fluid">
  <div class="modal fade" id="addEditOrderModal" tabindex="-1" role="dialog" aria-labelledby="addEditUserTitle"
    aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">{{popup_header}}</h5>
          <button type="button" class="close" data-bs-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <div class="row">
            <div class="col-md-10 offset-md-1">
              <form [formGroup]="addEditOrderForm" *ngIf="addEditOrderForm">
                <div class="input-group mb-3">
                  <label class="input-group-text" for="inputGroupFile01">Product&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</label>
                  <select class="form-select" formControlName="product" id="exampleFormControlSelect1" aria-label="Product select">
                    <option *ngFor="let product of products" [value]="JSON.stringify(product) ">
                      {{product.name}}
                    </option>
                  </select>
                  <div *ngIf="isFormSubmitted && rf.product.errors" class="invalid-feedback">
                    <div *ngIf="rf.product.errors.required">Product is required</div>
                  </div>
                </div>

                <div class="input-group mb-3">
                  <label class="input-group-text" for="inputGroupFile01">Quantity&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</label>
                  <input type="number" class="form-control" aria-label="Quantity" aria-describedby="basic-addon1" formControlName="quantity" [ngClass]="{'is-invalid':isFormSubmitted &&
                  rf.quantity.errors}" >
                  <div *ngIf="isFormSubmitted && rf.quantity.errors" class="invalid-feedback">
                    <div *ngIf="rf.quantity.errors.required">Quantity is required</div>
                  </div>
                </div>

                
                <div class="input-group mb-3">
                  <label class="input-group-text" for="inputGroupFile01">Unit (e.g. Kg)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</label>
                  <input type="text" class="form-control" formControlName="unit" [ngClass]="{'is-invalid':isFormSubmitted &&
                                      rf.unit.errors}" />
                  <div *ngIf="isFormSubmitted && rf.unit.errors" class="invalid-feedback">
                    <div *ngIf="rf.unit.errors.required">Unit is required</div>
                  </div>
                </div>
                
                <div class="input-group mb-3">
                  <label class="input-group-text" for="inputGroupFile01">Cost per Unit&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</label>
                  <input type="number" class="form-control" formControlName="costPerUnit" [ngClass]="{'is-invalid':isFormSubmitted &&
                                      rf.costPerUnit.errors}" />
                  <div *ngIf="isFormSubmitted && rf.costPerUnit.errors" class="invalid-feedback">
                    <div *ngIf="rf.costPerUnit.errors.required">Cost per Unit is required</div>
                  </div>
                </div>
                
                <div class="input-group mb-3">
                  <label class="input-group-text" for="inputGroupFile01">Sales Type&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</label>
                  <select class="form-control" placeholder="Sales Type" formControlName="sellType" id="exampleFormControlSelect1">
                    <option [value]=true>
                      Sell
                    </option>
                    <option [value]=false>
                      Buy
                    </option>

                  </select>
                  <div *ngIf="isFormSubmitted && rf.product.errors" class="invalid-feedback">
                    <div *ngIf="rf.product.errors.required">Sales Type is
                      required</div>
                  </div>
                </div>

                <div class="input-group mb-3">
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" value="" id="flexCheckDefault" formControlName="selfDelivery" [ngClass]="{'is-invalid':isFormSubmitted && addEditBidForm.get('selfDelivery').errors}">
                    <label class="form-check-label" for="flexCheckDefault">
                      Self Delivery
                    </label>
                  </div>
                  <div *ngIf="isFormSubmitted && addEditBidForm.get('selfDelivery').errors" class="invalid-feedback">
                    <div *ngIf="addEditBidForm.get('selfDelivery').errors.required">Self Delivery</div>
                  </div>
                </div>

                <div class="input-group mb-3">
                  <label class="input-group-text" for="inputGroupFile01">Delivery Date&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</label>
                  <input type="date" class="form-control" placeholder="Delivery Date" formControlName="deliveryDate" [ngClass]="{'is-invalid':isFormSubmitted &&
                        addEditBidForm.get('deliveryDate').errors}" />
                  <div *ngIf="isFormSubmitted && addEditBidForm.get('deliveryDate').errors" class="invalid-feedback">
                    <div *ngIf="addEditBidForm.get('deliveryDate').errors.required">Delivery Date</div>
                  </div>
                </div>
                
                <div class="input-group mb-3">
                  <label class="input-group-text" for="inputGroupFile01">Shipping Cost&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</label>
                  <input type="number" class="form-control" formControlName="shipCost" [ngClass]="{'is-invalid':isFormSubmitted &&
                        addEditBidForm.get('shipCost').errors}" />
                  <div *ngIf="isFormSubmitted && addEditBidForm.get('shipCost').errors" class="invalid-feedback">
                    <div *ngIf="addEditBidForm.get('shipCost').errors.required">Shipping Cost</div>
                  </div>
                </div>
                
                <div class="input-group mb-3">
                  <label class="input-group-text" for="inputGroupFile01">Harvest/Expected Date</label>
                  <input type="date" class="form-control" placeholder="Harvest/Expected Date" formControlName="expectedDate" [ngClass]="{'is-invalid':isFormSubmitted && addEditBidForm.get('expectedDate').errors}" />
                  <div *ngIf="isFormSubmitted && addEditBidForm.get('expectedDate').errors" class="invalid-feedback">
                    <div *ngIf="addEditBidForm.get('expectedDate').errors.required">Harvest/Expected Date</div>
                  </div>
                </div>  
                <br />
                <div class="input-group mb-3">
                  <button class="btn btn-primary" (click)="addNewOrder(wallet_pkh)" *ngIf="add_order">Add New</button>
                  <button class="btn btn-primary" (click)="updateOrder()" *ngIf="edit_order">Update</button>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal for add and edit bid  -->
<div class="container-fluid">
  <div class="modal fade" id="addEditBidModal" tabindex="-1" role="dialog" aria-labelledby="addEditUserTitle"
    aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">{{popup_header}}</h5>
          <button type="button" class="close" data-bs-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <dl class="row">
            <dt class="col-sm-5">Orderer</dt>
            <dd class="col-sm-7">{{ (single_order_data?.orderer.length>6)? (single_order_data?.orderer | slice:0:20)+'...':(single_order_data?.orderer) }}</dd>
          
            <dt class="col-sm-5">Order Date</dt>
            <dd class="col-sm-7">{{single_order_data?.dateCreated | date}}</dd>
          
            <dt class="col-sm-5">Product {{single_order_data?.sellType ? "for Sale" : "to Buy"}}</dt>
            <dd class="col-sm-7">{{single_order_data?.product.name}}</dd>
          
            <dt class="col-sm-5">Quantity</dt>
            <dd class="col-sm-7">{{single_order_data?.quantity}} ({{single_order_data?.unit | titlecase}})</dd>
            
            <dt class="col-sm-5">Cost per {{single_order_data?.unit | titlecase}}</dt>
            <dd class="col-sm-7">{{single_order_data?.costPerUnit}}</dd>

            <dt class="col-sm-5" *ngIf="single_order_data?.sellType">Harvest Date</dt>
            <dt class="col-sm-5" *ngIf="!single_order_data?.sellType">Expected Date</dt>
            <dd class="col-sm-7" *ngIf="single_order_data?.sellType">{{single_order_data?.expectedDate | date}}</dd>

            <dt class="col-sm-5" *ngIf="single_order_data?.sellType">Shippable</dt>
            <dt class="col-sm-5" *ngIf="!single_order_data?.sellType">Pickupable</dt>
            <dd class="col-sm-7">{{single_order_data?.selfDelivery ? "Yes" : "No"}}</dd>

            <dt class="col-sm-5" *ngIf="single_order_data?.selfDelivery && single_order_data?.sellType">Shipping Cost</dt>
            <dd class="col-sm-7" *ngIf="single_order_data?.selfDelivery && single_order_data?.sellType">{{single_order_data?.shipCost}}</dd>
            
            <dt class="col-sm-5" *ngIf="single_order_data?.selfDelivery && single_order_data?.sellType">Delivery Date</dt>
            <dd class="col-sm-7" *ngIf="single_order_data?.selfDelivery && single_order_data?.sellType">{{single_order_data?.deliveryDate | date}}</dd>

          </dl>
          
          <dl class="row" *ngIf="single_order_data?.orderer !== wallet_pkh">
            <dt class="col-sm-5">Total Bid Cost</dt>
            <dd class="col-sm-7">{{addEditBidForm.get('biddingPrice').value * addEditBidForm.get('bidQuantity').value}}</dd>
          </dl>

          <hr />

          <div class="row jumbotron" *ngIf="single_order_data?.orderer !== wallet_pkh; else elseBlock">
            <div class="col-md-10 offset-md-1">
              <form [formGroup]="addEditBidForm">

                <div class="input-group mb-3">
                  <label class="input-group-text" for="inputGroupFile01">Bidding Price per {{single_order_data?.unit | titlecase}}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</label>
                  <input type="number" class="form-control" formControlName="biddingPrice" [ngClass]="{'is-invalid':isFormSubmitted &&
                        addEditBidForm.get('biddingPrice').errors}" />
                  <div *ngIf="isFormSubmitted && addEditBidForm.get('biddingPrice').errors" class="invalid-feedback">
                    <div *ngIf="addEditBidForm.get('biddingPrice').errors.required">Bidding Price</div>
                  </div>
                </div>

                <div class="input-group mb-3">
                  <label class="input-group-text" for="inputGroupFile01">Bid Quantity&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</label>
                  <input type="number" class="form-control" formControlName="bidQuantity" [ngClass]="{'is-invalid':isFormSubmitted &&
                        addEditBidForm.get('bidQuantity').errors}" />
                  <div *ngIf="isFormSubmitted && addEditBidForm.get('bidQuantity').errors" class="invalid-feedback">
                    <div *ngIf="addEditBidForm.get('bidQuantity').errors.required">Bid Quantity</div>
                  </div>
                </div>
              
                <div class="input-group mb-3">
                  <label class="input-group-text" for="inputGroupFile01">Maximum Reaction Time</label>
                  <input type="date" class="form-control" formControlName="maxReactionTime" [ngClass]="{'is-invalid':isFormSubmitted &&
                        addEditBidForm.get('maxReactionTime').errors}" />
                  <div *ngIf="isFormSubmitted && addEditBidForm.get('maxReactionTime').errors" class="invalid-feedback">
                    <div *ngIf="addEditBidForm.get('maxReactionTime').errors.required">Maximum Reaction Time is required</div>
                  </div>
                </div>  
                
                <div class="input-group mb-3">
                  <button class="btn btn-primary" *ngIf="isBidCreate !! isViewOrder" (click)="addNewBid()">Send Bid</button>
                  <button class="btn btn-primary" *ngIf="!isBidCreate && isOrderClicked">Update</button>
                  <button class="btn btn-danger" *ngIf="!isBidCreate && isOrderClicked" (click)="deleteOrderBid()">Delete</button>
                </div>
              </form>
            </div>
          </div>
          <ng-template #elseBlock>
            <table class="table table-hover" *ngIf="!isViewOrder">
              <thead>
                <tr>
                  <th scope="col">#</th>
                  <th scope="col">Bidder</th>
                  <th scope="col">Quantity</th>
                  <th scope="col">Cost per Unit</th>
                  <th scope="col">Status</th>
                  <th scope="col">Action</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let bid_data of all_bid_data; let i= index">
                  <td>bid_data.id</td>
                  <td>{{ (bid_data.bidder.length>6)? (bid_data.bidder | slice:0:20)+'...':(bid_data.bidder) }}</td>
                  <td>{{bid_data.bidQuantity}} </td>
                  <td>{{bid_data.biddingPrice}}</td>
                  <td>{{bid_data.status}}</td>
                  <td>
                    <span class="sim-pointer" (click)="acceptOrderBid(bid_data)">
                      <i class="fa fa-check-circle" style="color: green;
                            font-size: 20px;"></i>
                    </span>
                    &nbsp;
                    <span class="sim-pointer" (click)="rejectOrderBid(bid_data)">
                      <i class="fa fa-times-circle" style="color: red;
                            font-size: 20px;"></i>
                    </span>
                  </td>
                </tr>
              </tbody>
            </table>
          </ng-template>
        </div>
      </div>
    </div>
  </div>
</div>
